---
title: "Project-NYPD"
author: "Leyi Cui, Qianhui Li"
date: "3/29/2022"
output: html_document
---

```{r}
NYPD <- read.csv("Data/2018_sqf_database-abbr.csv")
install.packages("tidyverse")
library(tidyverse)
library(ggplot2)
```

```{r}
# the number of stops in each month in the year 2018
# MONTH2: categorical variable
reorder_month <- c("January","February","March","April","May","June","July","August","September","October","November","December")
NYPD$MONTH2 = factor(NYPD$MONTH2,levels=reorder_month)
ggplot(NYPD, aes(MONTH2)) + geom_bar(alpha=0.90, colour="orange", fill="orange",width=0.75) + labs(title="", y="number of stops", x="month")
```

```{r}
# DAY2: Day when ppl are stopped

reorder_day <- c("Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday")
NYPD$DAY2 = factor(NYPD$DAY2,levels=reorder_day)
ggplot(NYPD, aes(DAY2)) + geom_bar(alpha=0.90, colour="salmon", fill="salmon",width=0.75) + labs(title="", y="number of stops", x="day")
```

```{r}
# Visualize: Stop Frisk Time: Time when ppl are stopped （清晨、深夜）

# Function: rounding(inputNum, totalNum)
rounding <- function(inputNum, totalNum) {
  if(is.na(inputNum)){return(FALSE)}else{
    m <- totalNum/2
    if(inputNum < m){
      # round down
      return(FALSE)
    }else{
      #round up
      return(TRUE)
    }
  }
}

hour<-NYPD$Stop.Frisk.Time
all_hour <- c()
for(i in 1:length(hour)){
  if(hour[i] == "#N/A" || is.na(hour[i]) || hour[i] == "" || hour[i] == FALSE){
    hour[i] <- "NA"
  }else{
    temp <- c(strsplit(hour[i], ":"))
    minBefore <- temp[[1]][[2]]
    hourBefore <- temp[[1]][[1]]
    if (rounding(strtoi(minBefore), 60)){
      hourAfter <- as.character(strtoi(hourBefore)+1)
      if (hourAfter == 24){
        hourAfter <- "0"
      }
    }else{
      hourAfter <- hourBefore
    }
    all_hour <- append(all_hour, hourAfter)
  }
  allH_df <- data.frame(all_hour)
}
reorder_hour <- c("0","1","2","3","4","5","6","7","8","9","10","11","12","13","14","15","16","17","18","19","20","21","22","23","NA")
allH_df$all_hour = factor(allH_df$all_hour,levels=reorder_hour)
ggplot(allH_df, aes(all_hour)) + geom_bar(alpha=0.90, colour="salmon", fill="salmon",width=0.75) + labs(title="", y="number of stops", x="hour")

# Morning: from sunrise to 11:59 AM. Sunrise typically occurs around 6 AM.
# Noon: at 12:00 PM.
# Afternoon: from 12:01 PM to around 5:00 PM.
# Evening: from 5:01 PM to 8 PM, or around sunset.
# Early Night: from sunset 11:59 PM
# Late Night: from 11:59 PM to sunrise around 5:59 AM.
all_period <- c()
for(i in 1:length(allH_df$all_hour)){
  if (allH_df$all_hour[i] == "6" || allH_df$all_hour[i] == "7" || allH_df$all_hour[i] == "8" || allH_df$all_hour[i] == "9" || allH_df$all_hour[i] == "10" || allH_df$all_hour[i] == "11"){
    all_period <- append(all_period, "Morning")
  }else if(allH_df$all_hour[i] == "12"){
    all_period <- append(all_period, "Noon")
  }else if(allH_df$all_hour[i] == "13" || allH_df$all_hour[i] == "14" || allH_df$all_hour[i] == "15" || allH_df$all_hour[i] == "16"){
    all_period <- append(all_period, "Afternoon")
  }else if(allH_df$all_hour[i] == "17" || allH_df$all_hour[i] == "18" || allH_df$all_hour[i] == "19" || allH_df$all_hour[i] == "20" || allH_df$all_hour[i] == "21" || allH_df$all_hour[i] == "22" || allH_df$all_hour[i] == "23"){
    all_period <- append(all_period, "Early Night")
  }else{
    all_period <- append(all_period, "Late Night")
  }
}
allP_df <- data.frame(all_period)
reorder_period <- c("Morning", "Noon", "Afternoon", "Early Night", "Late Night")
allP_df$all_period = factor(allP_df$all_period,levels=reorder_period)
ggplot(allP_df, aes(all_period)) + geom_bar(alpha=0.90, colour="salmon", fill="salmon",width=0.75) + labs(title="", y="number of stops", x="time period")
```

```{r}
# male vs female: dataframe
df_male_officer <- NYPD[NYPD$ISSUING_OFFICER_RANK == "POM",]
df_female_officer <- NYPD[NYPD$ISSUING_OFFICER_RANK == "POF",]
head(df_male_officer)
head(df_female_officer)

# male vs female: number of officers
male_female_num <- tibble(
  type = c("male officer", "female officer"),
  freq = c(nrow(df_male_officer), nrow(df_female_officer))
)
knitr::kable(male_female_num)

p <- ggplot(data = male_female_num, mapping = aes(
  x = type, y = freq ))
p + geom_col() +
  labs(x = "number of officers", 
       y = "sex")

p2 <- ggplot(data = male_female_num, mapping = aes(
  x = 1, y = freq, fill = type ))
p2 + geom_col() +
  coord_polar(theta = "y") +
  scale_x_discrete(name = NULL, breaks = NULL) +
  scale_y_discrete(name = NULL, breaks = NULL) +
  labs(fill = "Cut")
```

```{r}


# function: exclude outliers from the dataframe (only for numeric values); need to input a numeric vector

exclude_outliers <- function(x){
  Q1 <- quantile(x, .25)
  Q3 <- quantile(x, .75)
  IQR <- Q3-Q1
  outlier <- x<Q1-1.5*IQR | x>Q3+1.5*IQR
  clean_x <- x[!outlier]
  return(clean_x)
}
ex_out <- exclude_outliers(NYPD$OBSERVED_DURATION_MINUTES)
print(ex_out)
```

```{r}
## Observed duration minutes.

# Histogram --- Not excluded outliers
ggplot(NYPD,aes(OBSERVED_DURATION_MINUTES)) + geom_histogram(colour = "royalblue1", fill = "royalblue1",alpha=0.8) + labs(title="Distribution of Suspects' Observed Duration Minutes (including outliers)", y="count", x="observed duration mins")

# Histogram --- excluded outliers
table(NYPD$OBSERVED_DURATION_MINUTES)
ggplot(NYPD,aes(OBSERVED_DURATION_MINUTES)) + geom_histogram(breaks=seq(0,35,by=1), colour = "royalblue1", fill = "royalblue1",alpha=0.8) + labs(title="Distribution of Suspects' Observed Duration Minutes (excluding outliers)", y="count", x="observed duration mins")


## Stop duration minutes.

# Histogram --- Not excluded outliers
ggplot(NYPD,aes(STOP_DURATION_MINUTES)) + geom_histogram(colour = "royalblue3", fill = "royalblue3",alpha=0.8) + labs(title="Distribution of Suspects' Stopped Duration Minutes (including outliers)", y="count", x="stop duration mins") 

# Histogram --- excluded outliers
table(NYPD$STOP_DURATION_MINUTES)
ggplot(NYPD,aes(STOP_DURATION_MINUTES)) + geom_histogram(breaks=seq(0,50,by=1), colour = "royalblue3", fill = "royalblue3",alpha=0.8) + labs(title="Distribution of Suspects' Stopped Duration Minutes (excluding outliers)", y="count", x="stop duration mins") 

```

```{r}
# SUSPECTED_CRIME_DESCRIPTION

table(NYPD$SUSPECTED_CRIME_DESCRIPTION)
ggplot(NYPD, aes(SUSPECTED_CRIME_DESCRIPTION)) + geom_bar(alpha=0.90, colour="mediumpurple3", fill="mediumpurple3",width=0.5) + labs(title= "Suspected Types of Crimes", y="count", x="suspected crime description")


```

```{r}
# FRISKED_FLAG into dataframe

table(NYPD$FRISKED_FLAG)
```

```{r}
# SEARCHED_FLAG into dataframe

NYPD$FRISK_AND_SEARCH <- vector(mode='character', length(NYPD$FRISKED_FLAG))

for(i in seq_along(NYPD$FRISK_AND_SEARCH)){
  if(NYPD$FRISKED_FLAG[i] == "1" & NYPD$SEARCHED_FLAG[i] == "1"){
    NYPD$FRISK_AND_SEARCH[i] <- "Frisked and Searched"
    }else if (NYPD$FRISKED_FLAG[i] == "1" & NYPD$SEARCHED_FLAG[i] == "0") {
      NYPD$FRISK_AND_SEARCH[i] <- "Only Frisked"
      }else if (NYPD$FRISKED_FLAG[i] == "0" & NYPD$SEARCHED_FLAG[i] == "1") {
        NYPD$FRISK_AND_SEARCH[i] <- "Only Searched"
      }else{
        NYPD$FRISK_AND_SEARCH[i] <- "Not Frisked Nor Searched"
      }
  
}

table(NYPD$FRISK_AND_SEARCH)
ggplot(NYPD, aes(FRISK_AND_SEARCH)) + geom_bar(alpha=0.90, colour="mediumpurple3", fill="mediumpurple3",width=0.5) + labs(title= "The Number of Suspects Frisked or Searched", y="count", x="Frisked and Searched")


```

```{r}
# OFFICER_IN_UNIFORM_FLAG
NYPD[NYPD$OFFICER_IN_UNIFORM_FLAG==0,"OFFICER_IN_UNIFORM_FLAG"] <- "not wearing uniform"
NYPD[NYPD$OFFICER_IN_UNIFORM_FLAG==1,"OFFICER_IN_UNIFORM_FLAG"] <- "wearing uniform"
table(NYPD$OFFICER_IN_UNIFORM_FLAG)
ggplot(NYPD, aes(OFFICER_IN_UNIFORM_FLAG)) + geom_bar(alpha=0.90, colour="royalblue1", fill="royalblue1",width=0.75) + labs(title="", y="number of officers", x="officer in uniform")

```

```{r}
# SUSPECT_ARRESTED_FLAG 比对 overall
NYPD[NYPD$SUSPECT_ARRESTED_FLAG==0,"SUSPECT_ARRESTED_FLAG"] <- "suspect not arrested"
NYPD[NYPD$SUSPECT_ARRESTED_FLAG==1,"SUSPECT_ARRESTED_FLAG"] <- "suspect arrested"
table(NYPD$SUSPECT_ARRESTED_FLAG)
ggplot(NYPD, aes(SUSPECT_ARRESTED_FLAG)) + geom_bar(alpha=0.90, colour="royalblue1", fill="royalblue1",width=0.75) + labs(title="", y="number of stops", x="number os arrests")

# accuracy of overall stops
overall_a_acc <- 3115/11018
print(overall_a_acc)

# male officer's accuracy vs female officer's accuracy
df_male_officer[df_male_officer$SUSPECT_ARRESTED_FLAG==0,"SUSPECT_ARRESTED_FLAG"] <- "male_suspect not arrested"
df_male_officer[df_male_officer$SUSPECT_ARRESTED_FLAG==1,"SUSPECT_ARRESTED_FLAG"] <- "male_suspect arrested"
table(df_male_officer$SUSPECT_ARRESTED_FLAG)
df_female_officer[df_female_officer$SUSPECT_ARRESTED_FLAG==0,"SUSPECT_ARRESTED_FLAG"] <- "female_suspect not arrested"
df_female_officer[df_female_officer$SUSPECT_ARRESTED_FLAG==1,"SUSPECT_ARRESTED_FLAG"] <- "female_suspect arrested"
table(df_female_officer$SUSPECT_ARRESTED_FLAG)
male_a_acc <- 2639/(2639+6612)
print(male_a_acc)
female_a_acc <- 321/(321+904)
print(female_a_acc)
```

```{r}
# function1: variable X VS observe duration minutes (boxplots && scatterpoots)
observe_time_relation <- function(m){
  if(class(m) == "character"){
  ggplot(NYPD, aes(x = m, y = OBSERVED_DURATION_MINUTES)) + geom_boxplot(outlier.shape = NA) + coord_cartesian(ylim=c(0, 2.5))
}
else{
  ggplot(NYPD, aes(m, OBSERVED_DURATION_MINUTES)) + geom_point(outlier.shape = NA)
}
}


# function2: variable X VS stop duration minutes (boxplots && scatterpoots)
stop_time_relation <- function(n){
  if(class(n) == "character"){
  ggplot(NYPD, aes(x = n, y = STOP_DURATION_MINUTES)) + geom_boxplot(outlier.shape = NA) + coord_cartesian(ylim=c(0, 20))
}
else{
  ggplot(NYPD, aes(n, STOP_DURATION_MINUTES)) + geom_point()
}
}

observe_time_relation(NYPD$SUSPECT_SEX)

```

```{r}
# SUSPECT_REPORTED_AGE
# HOW TO REMOVE 0s??
class(NYPD$SUSPECT_REPORTED_AGE)
ggplot(NYPD,aes(SUSPECT_REPORTED_AGE)) + geom_histogram(colour = "orange3", fill = "orange3",alpha=0.8) + labs(title="", y="count", x="suspect reported age")

```

```{r}
# SUSPECT_SEX
class(NYPD$SUSPECT_SEX)
ggplot(NYPD, aes(SUSPECT_SEX)) + geom_bar(alpha=0.90, colour="salmon", fill="salmon",width=0.75) + labs(title="", y="count", x="suspect sex")
```

```{r}
# SUSPECT_RACE_DESCRIPTION
class(NYPD$SUSPECT_RACE_DESCRIPTION)
ggplot(NYPD, aes(SUSPECT_RACE_DESCRIPTION)) + geom_bar(alpha=0.90, colour="salmon", fill="salmon",width=0.5) + labs(title="", y="count", x="suspect race description") + theme(axis.text.x=element_text(size=4.1))
```

```{r}
# SUSPECT_HEIGHT 
# we remove NAs here
class(NYPD$SUSPECT_HEIGHT)
max(NYPD$SUSPECT_HEIGHT,na.rm=TRUE)
NYPD$SUSPECT_HEIGHT <- as.numeric(NYPD$SUSPECT_HEIGHT)
ggplot(NYPD,aes(SUSPECT_HEIGHT),na.rm=TRUE) + geom_histogram(colour = "orange3", fill = "orange3",alpha=0.8) + labs(title="", y="count", x="suspect height")


ggplot(NYPD, aes(SUSPECT_HEIGHT, OBSERVED_DURATION_MINUTES)) + geom_point(outlier.shape = NA) + coord_cartesian(ylim=c(0, 500))
```

```{r}
# SUSPECT_WEIGHT
# we remove NAs here
class(NYPD$SUSPECT_WEIGHT)
max(NYPD$SUSPECT_WEIGHT,na.rm=TRUE)
NYPD$SUSPECT_WEIGHT <- as.numeric(NYPD$SUSPECT_WEIGHT)
ggplot(NYPD,aes(SUSPECT_WEIGHT),na.rm=TRUE) + geom_histogram(colour = "orange3", fill = "orange3",alpha=0.8) + labs(title="", y="count", x="suspect weight")
```

```{r}
# SUSPECT_BODY_BUILD_TYPE
class(NYPD$SUSPECT_BODY_BUILD_TYPE)
ggplot(NYPD, aes(SUSPECT_BODY_BUILD_TYPE)) + geom_bar(alpha=0.90, colour="tomato", fill="tomato",width=0.5) + labs(title="", y="count", x="suspect body build type")
```

```{r}
# SUSPECT_EYE_COLOR
unique(NYPD$SUSPECT_EYE_COLOR)
ggplot(NYPD, aes(SUSPECT_EYE_COLOR)) + geom_bar(alpha=0.90, colour="tomato", fill="tomato",width=0.5) + labs(title="", y="count", x="suspect eye color")
```

```{r}
# SUSPECT_HAIR_COLOR
unique(NYPD$SUSPECT_HAIR_COLOR)
ggplot(NYPD, aes(SUSPECT_HAIR_COLOR)) + geom_bar(alpha=0.90, colour="tomato", fill="tomato",width=0.5) + labs(title="", y="count", x="suspect hair color")
```

```{r}
# STOP_LOCATION_BORO_NAME
table(NYPD$STOP_LOCATION_BORO_NAME)
ggplot(NYPD, aes(STOP_LOCATION_BORO_NAME)) + geom_bar(alpha=0.90, colour="orange3", fill="orange3",width=0.5) + labs(title="", y="count", x="stop borough")


# To verify function1 and function2 //
# Borough VS Stop Time
mean(NYPD$STOP_DURATION_MINUTES)
median(NYPD$STOP_DURATION_MINUTES)
ggplot(NYPD, aes(x = STOP_LOCATION_BORO_NAME, y = STOP_DURATION_MINUTES)) + geom_boxplot(outlier.shape = NA) + coord_cartesian(ylim=c(0, 20))

# Borough VS Observe Time
mean(NYPD$OBSERVED_DURATION_MINUTES)
median(NYPD$OBSERVED_DURATION_MINUTES)
ggplot(NYPD, aes(x = STOP_LOCATION_BORO_NAME, y = OBSERVED_DURATION_MINUTES)) + geom_boxplot(outlier.shape = NA) + coord_cartesian(ylim=c(0, 2.5))



```